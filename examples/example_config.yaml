# ============================================================================
# HBV Nanopore Pipeline - Example Configuration (Mini Dataset)
# ============================================================================
# This configuration is pre-configured for the included mini_dataset.
# You can run it directly after downloading the required reference files.
#
# Quick Start:
#   1. Download reference files (see instructions below)
#   2. Update the reference paths in this file
#   3. Run: ./run_pipeline.sh examples/example_config.yaml --sample 10090
#
# For a dry-run (no execution):
#   ./run_pipeline.sh examples/example_config.yaml --sample 10090 --dry-run
# ============================================================================

# ----- Project Paths -----
# These use relative paths from the repository root
project:
  # Working directory for pipeline outputs
  # Will be created automatically
  work_dir: "examples/mini_dataset/work"
  
  # Input FASTQ directory (included sample: 10090)
  raw_fastq_dir: "examples/mini_dataset/raw_fastq"
  
  # Results output directory
  results_dir: "examples/mini_dataset/results"

# ----- Reference Genomes -----
# IMPORTANT: Download these files before running the pipeline
# 
# HBV Reference Panel (provided in this repo for testing):
#   - A minimal reference is included for testing
#   - For production, use a complete multi-genotype panel
#
# Human Reference:
#   - Download GRCh38 from NCBI or Ensembl
#   - wget ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/000/001/405/GCA_000001405.15_GRCh38/seqs_for_alignment_pipelines.ucsc_ids/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.gz
#
reference:
  # HBV reference panel (all genotypes)
  # For this mini example, you can create a simple reference or use the full panel
  hbv_panel: "EDIT_THIS_PATH/hbv_panel.fasta"
  
  # Unified HBV reference (rotated, starts at DR1, offset=1823)
  hbv_unified: "EDIT_THIS_PATH/reordered_1824_3221_reference_A2763.fasta"
  
  # Human reference genome (for host decontamination)
  # Skip steps 5-6 if you don't have the human reference
  human_ref: "EDIT_THIS_PATH/GRCh38.primary_assembly.fa.gz"
  
  # HBV genome parameters (do not change)
  hbv_genome_length: 3221
  hbv_rotation_offset: 1823

# ----- Database Paths -----
databases:
  # Kraken2 database (optional for mini example)
  # Can skip step 5 if not available
  kraken2_db: "EDIT_THIS_PATH/kraken2_db"
  
  # Clair3 models (optional for mini example)
  # Can skip step 11 Clair3 portion if not available
  clair3_models: "EDIT_THIS_PATH/clair3_models"
  clair3_model_name: "r1041_e82_400bps_sup_v500"

# ----- Conda Environment Names -----
# These should match the environments created from environment/*.yml
conda_envs:
  base: "hbv_base"
  qc: "hbv_qc"
  medaka: "hbv_medaka"
  clair3: "hbv_clair3"
  variants: "hbv_variants"
  dorado: "dorado"

# ----- Resource Allocation -----
# Reduced for mini example (adjust based on your system)
resources:
  threads: 4
  java_memory_gb: 4
  threads_per_job: 2

# ----- QC Parameters -----
qc:
  dorado_kit: "SQK-NBD114-24"
  min_read_length: 2000
  max_read_length: 4000
  min_quality: 17
  nanoqc_min_length: 0

# ----- Host Deconvolution Parameters -----
host_deconv:
  hbv_min_mapq: 20
  hbv_min_match_len: 100
  hbv_merge_distance: 10
  human_min_mapq: 20
  human_min_match_len: 100
  human_min_frac: 0.05
  human_min_pid: 0.80
  human_min_total_aln: 200
  human_min_total_frac: 0.05
  tail_near_end: 80
  tail_max_len: 300
  tail_max_frac: 0.20
  tail_merge_distance: 10
  min_keep_len: 800
  discard_internal: true

# ----- Mapping Parameters -----
mapping:
  mm2_preset: "map-ont"
  min_mapq: 20

# ----- Coverage Analysis -----
coverage:
  window_size: 200
  window_step: 50
  low_cov_fraction: 0.20
  low_cov_absolute: 100
  mad_multiplier: 4
  homopolymer_min_4: 4
  homopolymer_min_6: 6
  homopolymer_pad: 5

# ----- Medaka Consensus -----
medaka:
  model: "r1041_e82_400bps_sup_v500"
  min_depth: 10

# ----- Variant Calling -----
variants:
  filter_profile: "lenient"
  ivar:
    min_quality: 20
    min_frequency: 0.01
    min_depth: 10
  clair3:
    var_pct_full: 1.0
    ref_pct_full: 1.0
    haploid_sensitive: true
    enable_head_tail_calling: true
  tiers:
    hc_min_af: 0.20
    mc_min_af: 0.05
    lf_min_af: 0.01
  blacklist:
    min_cohort_freq: 0.3
    max_af_threshold: 0.05

# ----- Output Options -----
output:
  keep_intermediate: true  # Keep intermediate files for learning
  compress_output: true
  generate_plots: true
