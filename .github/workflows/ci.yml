# GitHub Actions CI for HBV Nanopore WGS Pipeline
# 
# This workflow runs:
# - Code formatting checks (black)
# - Linting (ruff)
# - Unit tests (pytest)
#
# Note: Heavy integration tests requiring bioinformatics tools
# are not run in CI. They should be run locally with full dependencies.

name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black ruff pytest pytest-cov pyyaml
    
    - name: Check code formatting with black
      run: |
        black --check --diff scripts/ tests/ --line-length 100
    
    - name: Lint with ruff
      run: |
        ruff check scripts/ tests/ --ignore E501
      continue-on-error: true  # Don't fail on lint warnings
    
    - name: Run unit tests
      run: |
        PYTHONPATH=scripts pytest tests/test_coordinate_transform.py -v --tb=short
    
    - name: Run config parser tests
      run: |
        # Test the config parser module
        python scripts/utils/config_parser.py examples/example_config.yaml --summary
        python scripts/utils/config_parser.py examples/example_config.yaml --get project.work_dir

  # Separate job for more comprehensive testing (optional)
  test-coverage:
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pyyaml
    
    - name: Run tests with coverage
      run: |
        PYTHONPATH=scripts pytest tests/ -v --cov=scripts --cov-report=xml --cov-report=term-missing
      continue-on-error: true  # Some tests may require additional deps
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
      continue-on-error: true

  # Validate shell scripts (optional)
  shellcheck:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: './scripts'
        severity: warning
      continue-on-error: true  # Don't fail on shell warnings

